---
title: "Calculus Diversity"
author: "Irina Velsko"
date: "`r format(Sys.time(), '%b %d, %Y')`"
output:
    github_document:
        fig_width: 8
        fig_height: 6
        toc: true
---

```{r}
if (!require("BiocManager", quietly = TRUE)) {
  install.packages("BiocManager")
}

BiocManager::install("mixOmics")
```

```{r load_libraries, echo = F, message = F}
library(knitr)
library(data.table)
library(mixOmics)
library(vegan)
library(janitor)
library(tidyverse)
opts_chunk$set(echo = F, warning = F, message = F, dpi = 150)
```

Set the working directory of the notebook.  

```{r setup}
knitr::opts_knit$set(root.dir = normalizePath("."))
```

# MetaPhlAn3 diversity analyses
```{r cap1240K_samples}
# read in the individual metaphlan4 tables from each sample that was 1240K captured
cap1240K_list <- list.files(path = "/mnt/archgen/users/schumacher/bachelorthesis/04-analysis/metaphlan4", pattern = ".txt", full.names = T, recursive = TRUE)

cap1240K_info <- map_dfr(cap1240K_list, function(fn) {
  fread(fn, sep = "\t", fill = T, skip = 5) %>%
    mutate(Library_ID = basename(fn))
}) %>%
  bind_rows(.) %>%
  mutate(
    Library_ID = str_replace_all(Library_ID, ".metaphlan.profile.txt", ""),
    Dataset = "1240K"
  ) %>%
  rename(clade_name = 1)

# make a list of these Library_IDs
cap1240K_libIDs <- cap1240K_info %>%
  dplyr::select(Library_ID) %>%
  unique()

cap1240K_info %>%
  slice_head(n = 10)
```

```{r shotgun_samples}
# read in the combined metaphlan4 table of the samples that were shotgun sequenced without capture
shotgun_list <- list.files(path = "../../huebner/teaching/Bsc_interns/mp_week2/metaphlan4_shotgun", pattern = ".txt", full.names = T, recursive = TRUE)


# need to use this path b/c R won't read in the symlinks above
# this has additional data that we don't need, so after reading it all in, filter for only the samples we want (CSM, DSM)
# probably the filtering can be done with a regex but I don't have the time to figure it out
# shotgun_list <- list.files(path = "../../../microbiome_coprolite/paleofeces_assembly/04-analysis/metaphlan4/", pattern = ".txt", full.names = T, recursive = TRUE)

# read in a table that can convert the IDs from these files to the IDs in the other MetaPhlAn4 tables
id_table <- fread("./id_table.tsv")

shotgun_info <- map_dfr(shotgun_list, function(fn) {
  fread(fn, sep = "\t", fill = T, skip = 5) %>%
    mutate(Library_ID = basename(fn))
}) %>%
  bind_rows(.) %>%
  mutate(
    Library_ID = str_replace_all(Library_ID, ".metaphlan.profile.txt", ""),
    Dataset = "shotgun"
  ) %>%
  filter(str_detect(Library_ID, "CSM|DSM")) %>%
  rename(clade_name = 1) %>%
  # now change the Library_IDs to match the other table
  separate(Library_ID, into = c("ArchID", "libinfo"), sep = "-") %>%
  mutate(
    libinfo = str_replace_all(libinfo, "DD", ".B0101"),
    libinfo = str_replace_all(libinfo, "SD", ".B0102")
  ) %>%
  # except CSM001 is different
  mutate(libinfo = ifelse(ArchID == "CSM296" & str_detect(libinfo, "0101"), ".A0101",
    ifelse(ArchID == "CSM296" & str_detect(libinfo, "0102"), ".A0102", libinfo)
  )) %>%
  mutate(libinfo = ifelse(ArchID == "DSM006" & str_detect(libinfo, "0101"), ".A0101",
    ifelse(ArchID == "DSM006" & str_detect(libinfo, "0102"), ".A0102", libinfo)
  )) %>%
  full_join(., id_table, by = "ArchID") %>%
  select(clade_name, clade_taxid, relative_abundance, coverage, estimated_number_of_reads_from_the_clade, ArchID, Library_ID, everything()) %>%
  unite(Lib_ID, Library_ID:libinfo, sep = "") %>%
  filter(ArchID != "CSM299") %>%
  rename(Library_ID = Lib_ID)

shotgun_info %>%
  slice_head(n = 10)
```



```{r clean_data}
mpa4_tables <- cap1240K_info %>%
  # combine the tables into 1
  # bind_rows(., shotgun_info) %>%
  # filter to have only species
  filter(str_detect(clade_name, "s__")) %>%
  # but also remove all strain-level entries
  filter(!str_detect(clade_name, "t__")) %>%
  # remove the taxonomic hierarchy, so only the species name is left
  # separate the hierarchy into individual columns
  separate(clade_name, into = c("K", "P", "C", "O", "F", "G", "Species"), sep = "\\|") %>%
  # remove all columns that aren't species
  select(-c("K", "P", "C", "O", "F", "G")) %>%
  # get rid of the unnecessary species indicators in the names
  mutate(
    Species = str_replace_all(Species, "s__", ""),
    Species = str_replace_all(Species, "_", " ")
  ) %>%
  # arrange alphabetically
  arrange(Library_ID) %>%
  select(Dataset, Library_ID, Species, relative_abundance)

# and the genus-level instead
mpa4_tables_g <- cap1240K_info %>%
  # combine the tables into 1
  # bind_rows(., shotgun_info) %>%
  # filter to have only species
  filter(str_detect(clade_name, "g__")) %>%
  # but also remove all strain-level entries
  filter(!str_detect(clade_name, "s__")) %>%
  # remove the taxonomic hierarchy, so only the species name is left
  # separate the hierarchy into individual columns
  separate(clade_name, into = c("K", "P", "C", "O", "F", "Genus", "S"), sep = "\\|") %>%
  # remove all columns that aren't species
  select(-c("K", "P", "C", "O", "F", "S")) %>%
  # get rid of the unnecessary species indicators in the names
  mutate(
    Genus = str_replace_all(Genus, "g__", ""),
    Genus = str_replace_all(Genus, "_", " ")
  ) %>%
  # arrange alphabetically
  arrange(Library_ID) %>%
  select(Dataset, Library_ID, Genus, relative_abundance)
```


Need to:
1. Decontaminate tables
2. How many species are in each sample?
3. Shannon index samples?
4. Beta-diversity samples - separate by site?
How comparable are the 2 datasets?
5. Compare # species and shannon index between 1240K and shotgun data
6. Compare beta-diversity between 1240K and shotgun data
7. Is library type different in 1240K dataset?

Now decontam the tables
```{r contaminants, eval = F}
# read in the contamminants identified by decontam


# remove contaminant species from nt table
```


```{r load_metadata, eval = F}
# there is no metadata file this time
```


## Alpha-diversity

### Most abundant genera
```{r}
# Plot the 5 most abundant species in each sample to see whether there are any highly abundant contaminants
# and to look at the variation across the samples

mpa4_tables_g %>%
  group_by(Dataset, Library_ID) %>%
  arrange(desc(relative_abundance)) %>%
  slice_max(relative_abundance, n = 5) %>%
  ungroup() %>%
  ggplot(., aes(x = Library_ID, y = relative_abundance, fill = Genus)) +
  geom_bar(stat = "identity", color = "grey30", size = 0.2) +
  theme_minimal() +
  # scale_y_log10(breaks = c(1, 10, 25, 50, 100)) +
  # scale_y_continuous(trans=scales::pseudo_log_trans(base = 10),  breaks = c(0.1, 1, 10, 50, 100)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(panel.grid.major.x = element_blank()) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 8)) +
  xlab("Sample") +
  ylab("Relative abundance") +
  facet_wrap(~Dataset)
ggsave("Most_abundant_genera.jpg")
# facet_grid(~Dataset, scales = "free_x", space = 'free')
```




### Observed Speceies
```{r observed_species}
# make percent into a binary presence/absence table
mpa4_tables.os <- mpa4_tables %>%
  # filter out all species that are not present in each sample
  filter(relative_abundance > 0) %>%
  group_by(Dataset, Library_ID) %>%
  # count the # of species
  count(name = "no_species") %>%
  ungroup()

# plot the number of species per sample grouped by the site the samples come from
mpa4_tables.os %>%
  # add the site for plotting
  mutate(Site = "Yukechi Alas, Siberia") %>%
  # set the order of the Dataset for plotting
  mutate(Dataset = fct_relevel(Dataset, "shotgun", "1240K")) %>%
  arrange(Dataset) %>%
  # remove any additional samples that were added back by the library but aren't calculus
  ggplot(., aes(x = Site, y = no_species, fill = Dataset)) +
  geom_boxplot(color = "grey30", outlier.colour = NA) +
  geom_point(alpha = 0.5, color = "grey30", position = position_jitterdodge(jitter.width = 0.2)) +
  theme_minimal(base_size = 16) +
  ylab("Observed species") +
  xlab("Site")
ggsave("Observed_Speceies.jpg")
```

```{r species_counts_stats}
# test for significant differences between groups
```

### Shannon diversity
```{r shannon_diversity}
# create a data table that's a matrix (not a data.frame) for input to vegan
# one table per dataset
mpa4_sp_cap1240.matrix <- as.matrix(mpa4_tables %>%
  filter(Dataset == "1240K") %>%
  select(-Dataset) %>%
  pivot_wider(names_from = "Species", values_from = "relative_abundance", values_fill = 0) %>%
  column_to_rownames("Library_ID"))

mpa4_sp_shotgun.matrix <- as.matrix(mpa4_tables %>%
  filter(Dataset == "shotgun") %>%
  select(-Dataset) %>%
  pivot_wider(names_from = "Species", values_from = "relative_abundance", values_fill = 0) %>%
  column_to_rownames("Library_ID"))

# Calculate Shannon diversity with the package vegan
# mpa4_sp.shannon <- as.data.frame(diversity(mpa4_sp_cap1240.matrix, index = "shannon")) %>%
#   # fix the column name to be Shannon_index
#   rename(Shannon_index = 1) %>%
#   # add a column with the dataset for plotting
#   mutate(Dataset = "1240K") %>%
#   rownames_to_column("Library_ID") %>%
#   # now repeat for the shotgun data and add it to the first table, at the same time
#   bind_rows(., as.data.frame(diversity(mpa4_sp_shotgun.matrix, index = "shannon")) %>%
#     rename(Shannon_index = 1) %>%
#     # add a column with the dataset for plotting
#     mutate(Dataset = "shotgun") %>%
#    rownames_to_column("Library_ID"))


# Plot the Shannon index as a boxplot
mpa4_sp.shannon %>%
  # add the site for plotting
  mutate(Site = "Yukechi Alas, Siberia") %>%
  # set the order of the Dataset for plotting
  mutate(Dataset = fct_relevel(Dataset, "shotgun", "1240K")) %>%
  arrange(Dataset) %>%
  ggplot(., aes(x = Site, y = Shannon_index, fill = Dataset)) +
  geom_boxplot(color = "grey30", outlier.colour = NA) +
  geom_point(alpha = 0.5, color = "grey30", position = position_jitterdodge(jitter.width = 0.2)) +
  theme_minimal(base_size = 16) +
  ylab("Shannon index") +
  xlab("Site")
ggsave("Shannon_diversity.jpg")
```

```{r shannon_stats}
# test for significant differences between groups
```


## Beta-diversity
### All samples
```{r pca_table_prep}
# prepare the table for PCA
mpa4_tables_bdiv <- mpa4_tables %>%
  select(Library_ID, Dataset, everything()) %>%
  unite(libID, Library_ID:Dataset, sep = "-") %>%
  mutate(relative_abundance = relative_abundance + 1) %>%
  pivot_wider(names_from = "Species", values_from = "relative_abundance", values_fill = 1) %>%
  column_to_rownames("libID")
```

PCA plot (link dots of the same sample between shotgun and 1240K)
```{r pca}
# run the PCA
mpa4_tables_bdiv.pca <- mixOmics::pca(mpa4_tables_bdiv, ncomp = 5, logratio = "CLR")

# plot the scree plot
plot(mpa4_tables_bdiv.pca)

# make a dataframe with the PC loadings for all samples
mpa4_tables_bdiv.df <- mpa4_tables_bdiv.pca$variates$X %>%
  as.data.frame() %>%
  rownames_to_column("LibID") %>%
  # add the site for plotting
  mutate(Site = "Yukechi Alas, Siberia") %>%
  # make the dataset a column again
  separate(LibID, into = c("Library_ID", "Dataset"), sep = "-") %>%
  select(Library_ID, Dataset, Site, everything()) %>%
  # set the order of the Dataset for plotting
  mutate(Dataset = fct_relevel(Dataset, "shotgun", "1240K")) %>%
  arrange(Dataset)

# make a table with the % of variation per PC
exp_var <- paste0(round(mpa4_tables_bdiv.pca$prop_expl_var$X * 100, 2), "%")
```

```{r pca_plot}
# plot the points in PC1 and PC2 space
ggplot(mpa4_tables_bdiv.df, aes(PC1, PC2, fill = Site, shape = Dataset)) +
  geom_point(size = 2, color = "black") +
  scale_shape_manual(values = c(24, 21)) +
  xlab(paste("PC1 - ", exp_var[1])) +
  ylab(paste("PC2 - ", exp_var[2])) +
  theme_minimal(base_size = 16) +
  theme(
    legend.title = element_blank(),
    legend.key.size = unit(2, "mm"),
    legend.text = element_text(size = 6)
  ) +
  theme(legend.position = "top")
ggsave("Beta_diversity_All_samples.jpg")
```

```{r pca_plot_connect}
# plot the points in PC1 and PC2 space
mpa4_tables_bdiv.df %>%
  ggplot(.) +
  geom_point(aes(x = PC1, y = PC2, fill = Site, shape = Dataset), color = "black", size = 2) +
  geom_line(aes(x = PC1, y = PC2, group = Library_ID), linetype = "dotted") +
  scale_shape_manual(values = c(24, 21)) +
  xlab(paste("PC1 - ", exp_var[1])) +
  ylab(paste("PC2 - ", exp_var[2])) +
  theme_minimal(base_size = 16) +
  theme(
    legend.title = element_blank(),
    legend.key.size = unit(2, "mm"),
    legend.text = element_text(size = 6)
  ) +
  theme(legend.position = "top") +
  ggtitle("") +
  theme(plot.title = element_text(size = 10))
```


### 1240K samples only
```{r pca_table_prep}
# prepare the table for PCA
mpa4_tables_1240k_bdiv <- mpa4_tables %>%
  filter(Dataset == "1240K") %>%
  select(-Dataset) %>%
  mutate(relative_abundance = relative_abundance + 1) %>%
  pivot_wider(names_from = "Species", values_from = "relative_abundance", values_fill = 1) %>%
  column_to_rownames("Library_ID")
```

PCA plot (link dots of the same sample between shotgun and 1240K)
```{r pca}
# run the PCA
mpa4_tables_1240k_bdiv.pca <- mixOmics::pca(mpa4_tables_1240k_bdiv, ncomp = 5, logratio = "CLR")

# plot the scree plot
plot(mpa4_tables_1240k_bdiv.pca)

# make a dataframe with the PC loadings for all samples
mpa4_tables_1240K_bdiv.df <- mpa4_tables_1240k_bdiv.pca$variates$X %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  # add the site for plotting
  mutate(Site = "Yukechi Alas, Siberia") %>%
  # make the dataset a column again
  select(Library_ID, Site, everything()) %>%
  # make a new column with the sampleIDs and a new column with the library type (single-stranded or double-stranded)
  mutate(
    Sample_ID = str_trunc(Library_ID, 6, side = "right", ellipsis = ""),
    Lib_type = ifelse(str_detect(Library_ID, "0101"), "ds", "ss")
  ) %>%
  select(Library_ID, Sample_ID, Lib_type, Site, everything())

# make a table with the % of variation per PC
exp_var <- paste0(round(mpa4_tables_1240k_bdiv.pca$prop_expl_var$X * 100, 2), "%")
```


```{r pca_1240K_connect}
# plot the points in PC1 and PC2 space
mpa4_tables_1240K_bdiv.df %>%
  ggplot(.) +
  geom_point(aes(x = PC1, y = PC2, fill = Site, shape = Lib_type), color = "black", size = 2) +
  geom_line(aes(x = PC1, y = PC2, group = Sample_ID), linetype = "dotted") +
  scale_shape_manual(values = c(25, 22)) +
  xlab(paste("PC1 - ", exp_var[1])) +
  ylab(paste("PC2 - ", exp_var[2])) +
  theme_minimal(base_size = 16) +
  theme(
    legend.title = element_blank(),
    legend.key.size = unit(2, "mm"),
    legend.text = element_text(size = 6)
  ) +
  theme(legend.position = "top")
ggsave("Beta_diversity_1240k_samples.jpg")
```


```{r}
# Is there anything else to test?
```

